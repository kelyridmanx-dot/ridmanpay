<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0aa7c7" />
  <title>Ridman Pay</title>

  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#dbe5f1;
      --brand:#0aa7c7;
      --brand2:#0ea5e9;

      /* ✅ Azul más suave para el recibo */
      --receiptBlue:#3f79a6;        /* banda superior */
      --receiptStrip:#7fb2d2;       /* franja título */
      --receiptBorder:#cfd8e3;

      --ok:#16a34a;
      --value:#1d4ed8;
      --shadow: 0 12px 35px rgba(2,6,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 28px;}
    .top{
      background:linear-gradient(180deg,#12b0ee,#0aa7c7);
      border-radius:26px;
      padding:28px 18px;
      box-shadow:var(--shadow);
      text-align:center;
      color:#fff;
      margin:8px 0 18px;
    }
    .top .t1{font-weight:900;letter-spacing:.35em;font-size:42px;}
    .top .t2{margin-top:10px;font-weight:700;opacity:.95;font-size:18px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(219,229,241,.7);
      padding:16px;
      margin-bottom:16px;
    }
    h1{
      margin:8px 0 14px;
      font-size:54px;
      line-height:1;
      font-weight:900;
    }
    .tip{
      display:flex;gap:12px;
      border-radius:14px;
      background:#e7f6ff;
      border:2px solid #b9e6ff;
      padding:14px;
      margin-bottom:14px;
      font-weight:700;
    }
    .grid{display:grid;gap:12px;}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
    @media(max-width:720px){
      h1{font-size:44px}
      .top .t1{font-size:32px;letter-spacing:.25em}
      .grid2{grid-template-columns:1fr}
    }
    label{display:block;margin:0 0 6px;color:var(--muted);font-weight:900}
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:70px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .primary{background:var(--brand2);border-color:transparent;color:#fff}
    .primary:hover{filter:brightness(.95)}
    .danger{background:#fee2e2;border-color:#fecaca}
    .share{
      border-radius:14px;
      background:#e7f6ff;
      border:1px solid #b9e6ff;
      padding:14px;
      margin-bottom:12px;
    }
    .share h3{margin:0 0 10px;text-align:center}
    .share p{margin:0;font-weight:700}
    .hist .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      background:#fff;
    }
    .hist .t{font-weight:900}
    .hist .s{color:var(--muted);font-weight:800;margin-top:4px}
    .mini{padding:10px 12px;border-radius:10px}

    /* Modal */
    .back{
      position:fixed;inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(960px, 100%);
      background:#fff;
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .pill{font-weight:900}
    .close{font-size:20px;padding:10px 12px}
    .modalGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:900px){.modalGrid{grid-template-columns:1fr}}
    pre{
      margin:0;
      background:#0b1220;
      color:#e2e8f0;
      border-radius:14px;
      padding:12px;
      overflow:auto;
      font-size:13px;
      line-height:1.35;
      min-height:240px;
    }
    .imgBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:grid;
      place-items:center;
      background:#fff;
    }
    img{max-width:100%;height:auto;display:block}
    canvas{display:none}
    small{color:var(--muted);font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="t1">RIDMAN PAY</div>
      <div class="t2">Cotización de transferencia Perú - Rusia</div>
    </div>

    <div class="card">
      <h1>Nueva operación</h1>

      <div class="tip">
        <div>⚠️</div>
        <div>
          Tip: si el cliente entrega <b>SOLES</b>, normalmente usa el tipo de cambio <b>ALTO</b> (venta).
          Si entrega <b>DÓLARES</b>, usa el tipo de cambio <b>BAJO</b> (compra).
          <b>Si entrega RUBLOS</b>, usamos tasa <b>RUB → USD</b>.
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Dirección</label>
          <select id="direccion">
            <option value="PE_RU">Perú → Rusia</option>
            <option value="RU_PE">Rusia → Perú</option>
            <option value="RU_CO">Rusia → Colombia</option>
          </select>
        </div>

        <div>
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>

        <div>
          <label>Moneda de entrega</label>
          <select id="monedaEntrega">
            <option value="PEN">PEN (Soles)</option>
            <option value="USD">USD (Dólares)</option>
            <option value="RUB">RUB (Rublo)</option>
          </select>
        </div>

        <div>
          <label>Entrega</label>
          <input id="entrega" type="number" step="0.01" inputmode="decimal" placeholder="0.00">
        </div>

        <div class="grid2">
          <div>
            <label id="lblTasa1">Tasa Perú (PEN → USD)</label>
            <input id="tasa1" type="number" step="0.0001" inputmode="decimal" placeholder="3.9800">
          </div>
          <div>
            <label id="lblTasa2">Tasa Rusia (USD → RUB)</label>
            <input id="tasa2" type="number" step="0.0001" inputmode="decimal" placeholder="79.5000">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Comisión</label>
            <select id="modoComision">
              <option value="AUTO">Automático</option>
              <option value="MANUAL">Manual</option>
            </select>
            <div id="wrapComisionManual" style="display:none;margin-top:10px">
              <input id="comisionManual" type="number" step="0.01" inputmode="decimal" placeholder="10.00">
            </div>
          </div>
          <div>
            <label>Cliente</label>
            <input id="cliente" type="text" placeholder="MARIA">
          </div>
        </div>

        <div>
          <label>Observación</label>
          <textarea id="obs" placeholder="(Opcional)"></textarea>
        </div>

        <div class="btns">
          <button class="primary" id="btnGuardarAbrir">Guardar y abrir</button>
          <button id="btnPreview">Vista previa</button>
          <button id="btnCopiarTexto">Copiar texto</button>
          <button id="btnNuevo">Nuevo</button>
          <button id="btnCsv">Exportar CSV</button>
          <button class="danger" id="btnBorrarTodo">Borrar todo</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="share">
        <h3>Reenviar como IMAGEN (WhatsApp / Telegram)</h3>
        <p>Si estás en laptop y no aparece “compartir”, usa Descargar imagen y la envías por WhatsApp Web / Telegram Desktop.</p>
      </div>

      <div class="hist">
        <div id="historial"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="pill" id="pillDir">✅ Transferencia Perú → Rusia</div>
        <button class="close" id="btnClose">✕</button>
      </div>

      <div class="modalGrid">
        <div>
          <pre id="txtRecibo"></pre>
          <div class="btns" style="margin-top:10px">
            <button id="btnCopiarModal">Copiar texto</button>
            <button class="primary" id="btnDescargarImg">Descargar imagen</button>
            <button class="primary" id="btnShareImg">Compartir imagen</button>
          </div>
          <small id="smallNote"></small>
        </div>

        <div class="imgBox">
          <img id="imgRecibo" alt="Vista previa (imagen)">
          <canvas id="canvasRecibo" width="1080" height="1400"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // ========= CONFIG RUTAS (según tu Excel) =========
  const ROUTES = {
    PE_RU: {
      key:"PE_RU",
      from:"Perú", to:"Rusia",
      entregaAllowed:["PEN","USD"],
      tasa1Label:"Tasa Perú (PEN → USD)",
      tasa2Label:"Tasa Rusia (USD → RUB)",
      tasa1Mode:"LOCAL_PER_USD", // 1 USD = X PEN
      tasa2Mode:"LOCAL_PER_USD", // 1 USD = X RUB
      recibeCur:"RUB"
    },
    RU_PE: {
      key:"RU_PE",
      from:"Rusia", to:"Perú",
      entregaAllowed:["RUB"],
      tasa1Label:"Tasa Rusia (RUB → USD)",
      tasa2Label:"Tasa Perú (USD → PEN)",
      tasa1Mode:"LOCAL_PER_USD", // 1 USD = X RUB
      tasa2Mode:"LOCAL_PER_USD", // 1 USD = X PEN
      recibeCur:"PEN"
    },
    RU_CO: {
      key:"RU_CO",
      from:"Rusia", to:"Colombia",
      entregaAllowed:["RUB"],
      tasa1Label:"Tasa Rusia (RUB → USD)",
      tasa2Label:"Tasa Colombia (USD → COP)",
      tasa1Mode:"LOCAL_PER_USD", // 1 USD = X RUB
      tasa2Mode:"LOCAL_PER_USD", // 1 USD = X COP
      recibeCur:"COP"
    }
  };

  // ========= HELPERS =========
  const round2 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;
  const round4 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 10000) / 10000;
  const fmt2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtRate2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});

  function todayISO(){
    const d = new Date();
    const pad=(x)=>String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function calcCommissionUSD(importeUSD){
    const x = Number(importeUSD||0);
    const eps = 1e-9;
    if(x <= 300 + eps) return 10;
    if(x <= 600 + eps) return 15;
    if(x <= 1000 + eps) return 25;
    if(x <= 1600 + eps) return 30;
    return round2(x * 0.017);
  }

  function formatEntrega(cur, amount){
    if(cur==="PEN") return `S/ ${fmt2(amount)} (PEN)`;
    if(cur==="USD") return `USD ${fmt2(amount)} (USD)`;
    if(cur==="RUB") return `RUB ${fmt2(amount)} (RUB)`;
    return `${cur} ${fmt2(amount)} (${cur})`;
  }

  function formatRecibe(cur, amount){
    if(cur==="PEN") return `S/ ${fmt2(amount)} (PEN)`;
    if(cur==="RUB") return `${fmt2(amount)} rublos`;
    if(cur==="COP") return `COP ${fmt2(amount)} (COP)`;
    return `${cur} ${fmt2(amount)} (${cur})`;
  }

  function applyRouteUI(){
    const r = ROUTES[$("direccion").value] || ROUTES.PE_RU;

    $("lblTasa1").textContent = r.tasa1Label;
    $("lblTasa2").textContent = r.tasa2Label;

    // Moneda entrega permitida según ruta
    const sel = $("monedaEntrega");
    const allowed = new Set(r.entregaAllowed);

    [...sel.options].forEach(opt=>{
      opt.disabled = !allowed.has(opt.value);
      opt.hidden = !allowed.has(opt.value);
    });

    // Forzar selección válida
    if(!allowed.has(sel.value)){
      sel.value = r.entregaAllowed[0];
    }

    // Bloquear selector si solo hay 1 opción
    sel.disabled = (r.entregaAllowed.length === 1);
  }

  function computeOperationFromInputs(){
    const r = ROUTES[$("direccion").value] || ROUTES.PE_RU;

    const direccion = r.key;
    const fecha = $("fecha").value || todayISO();
    const monedaEntrega = $("monedaEntrega").value;
    const entrega = Number($("entrega").value || 0);

    const tasa1 = Number($("tasa1").value || 0);
    const tasa2 = Number($("tasa2").value || 0);

    const cliente = ($("cliente").value || "").trim();
    const obs = ($("obs").value || "").trim();

    // ✅ convertir entrega → USD (para comisión y monto a enviar)
    let importeUSD = 0;
    if(monedaEntrega === "USD"){
      importeUSD = entrega;
    } else {
      // Formato: 1 USD = X (PEN/RUB)
      importeUSD = (tasa1 > 0) ? (entrega / tasa1) : 0;
    }

    const comMode = $("modoComision").value;
    let comisionUSD = 0;
    if(comMode === "MANUAL"){
      comisionUSD = Number($("comisionManual").value || 0);
    } else {
      comisionUSD = calcCommissionUSD(importeUSD);
    }

    const montoEnviarUSD = Math.max(0, importeUSD - comisionUSD);

    // ✅ recibe en moneda destino
    const recibe = montoEnviarUSD * tasa2;
    const recibeText = formatRecibe(r.recibeCur, recibe);

    return {
      id: crypto.randomUUID(),
      direccion,
      fecha,
      monedaEntrega,
      entrega: round2(entrega),
      tasa1: round4(tasa1),
      tasa2: round4(tasa2),
      cliente,
      obs,
      importeUSD: round2(importeUSD),
      comisionUSD: round2(comisionUSD),
      montoEnviarUSD: round2(montoEnviarUSD),
      recibeCur: r.recibeCur,
      recibeText,
      from:r.from,
      to:r.to,
      tasa1Label:r.tasa1Label,
      tasa2Label:r.tasa2Label
    };
  }

  function buildReceiptText(op){
    const from = op.from || (ROUTES[op.direccion]?.from || "—");
    const to = op.to || (ROUTES[op.direccion]?.to || "—");
    const dirTxt = `Transferencia ${from} → ${to}`;

    const cliente = (op.cliente || op.clienteNombre || "").trim();
    const obs = (op.obs || op.observacion || "").trim();

    const lines = [];
    lines.push(`✅ ${dirTxt}`);
    lines.push(`Fecha: ${op.fecha}`);
    lines.push(`Entrega: ${formatEntrega(op.monedaEntrega, op.entrega)}`);

    // Mostrar tasas con formato simple
    // tasa1: 1 USD = X (PEN/RUB)
    if(op.monedaEntrega !== "USD"){
      const cur = op.monedaEntrega;
      lines.push(`Tasa ${cur} → USD: 1 USD = ${fmtRate2(op.tasa1)} ${cur}`);
    }

    // tasa2: 1 USD = X destino
    lines.push(`Tasa USD → ${op.recibeCur}: 1 USD = ${fmtRate2(op.tasa2)} ${op.recibeCur}`);

    lines.push(`Importe (USD): USD ${fmt2(op.importeUSD)} USD`);
    lines.push(`Comisión: USD ${fmt2(op.comisionUSD)}`);
    lines.push(`Monto a enviar: USD ${fmt2(op.montoEnviarUSD)} USD`);
    lines.push(`Recibe: ${op.recibeText}`);

    if(cliente) lines.push(`Cliente: ${cliente}`);
    if(obs) lines.push(`Observación: ${obs}`);

    return lines.join("\n");
  }

  // ========= DIBUJO DEL RECIBO (IMAGEN) =========
  function roundRectPath(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function fitText(ctx, text, maxWidth, baseFont){
    ctx.font = baseFont;
    if(ctx.measureText(text).width <= maxWidth) return;
    // reducir tamaño
    const m = baseFont.match(/(\d+)px/);
    if(!m) return;
    let size = Number(m[1]);
    while(size > 18){
      const f = baseFont.replace(/\d+px/, `${size}px`);
      ctx.font = f;
      if(ctx.measureText(text).width <= maxWidth) return;
      size -= 2;
    }
  }

  function drawReceiptToCanvas(op){
    const c = $("canvasRecibo");
    const ctx = c.getContext("2d");

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,c.width,c.height);

    // Fondo blanco total
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,c.width,c.height);

    const pad = 56;
    const cardX = pad;
    const cardY = pad;
    const cardW = c.width - pad*2;

    // Contenido tabla (✅ incluye cliente SIEMPRE si existe)
    const cliente = (op.cliente || op.clienteNombre || "").trim();
    const obs = (op.obs || op.observacion || "").trim();

    const rows = [];
    rows.push(["Fecha:", op.fecha]);
    rows.push(["Entrega:", formatEntrega(op.monedaEntrega, op.entrega)]);

    if(op.monedaEntrega !== "USD"){
      rows.push([`Tasa ${op.monedaEntrega} → USD`, `1 USD = ${fmtRate2(op.tasa1)} ${op.monedaEntrega}`]);
    }

    rows.push([`Tasa USD → ${op.recibeCur}`, `1 USD = ${fmtRate2(op.tasa2)} ${op.recibeCur}`]);
    rows.push(["Importe (USD):", `USD ${fmt2(op.importeUSD)} USD`]);
    rows.push(["Comisión:", `USD ${fmt2(op.comisionUSD)}`]);
    rows.push(["Monto a enviar:", `USD ${fmt2(op.montoEnviarUSD)} USD`]);
    rows.push(["Recibe:", op.recibeText]);

    if(cliente) rows.push(["Cliente:", cliente.toUpperCase()]);
    if(obs) rows.push(["Obs:", obs]);

    // Medidas
    const headerH = 200;         // banda azul grande
    const stripH  = 90;          // franja titulo
    const gapAfterStrip = 18;

    const rowH = 98;
    const tableH = rows.length * rowH;

    const cardH = headerH + stripH + gapAfterStrip + tableH + 34; // ✅ sin “bloque azul” abajo
    const cardY2 = cardY;
    const cardH2 = Math.min(cardH, c.height - pad*2);

    // sombra suave
    ctx.save();
    ctx.fillStyle = "rgba(15,23,42,.08)";
    roundRectPath(ctx, cardX+10, cardY2+12, cardW, cardH2, 28);
    ctx.fill();
    ctx.restore();

    // tarjeta blanca con borde gris
    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--receiptBorder").trim() || "#cfd8e3";
    ctx.lineWidth = 4;
    roundRectPath(ctx, cardX, cardY2, cardW, cardH2, 28);
    ctx.fill();
    ctx.stroke();

    // Header azul (arriba)
    const blue = getComputedStyle(document.documentElement).getPropertyValue("--receiptBlue").trim() || "#3f79a6";
    ctx.fillStyle = blue;
    roundRectPath(ctx, cardX, cardY2, cardW, headerH, 28);
    ctx.fill();

    // Texto Ridman Pay
    ctx.fillStyle = "#ffffff";
    ctx.textAlign = "center";
    ctx.textBaseline = "alphabetic";
    ctx.font = "900 84px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("Ridman Pay", cardX + cardW/2, cardY2 + 130);

    // Línea separación
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(cardX + 42, cardY2 + headerH);
    ctx.lineTo(cardX + cardW - 42, cardY2 + headerH);
    ctx.stroke();

    // Franja título (azul claro) + check + texto (con auto-ajuste)
    const stripY = cardY2 + headerH + 14;
    const strip = getComputedStyle(document.documentElement).getPropertyValue("--receiptStrip").trim() || "#7fb2d2";
    ctx.fillStyle = strip;
    roundRectPath(ctx, cardX + 22, stripY, cardW - 44, stripH, 18);
    ctx.fill();

    // Check
    ctx.fillStyle = "#22c55e";
    roundRectPath(ctx, cardX + 46, stripY + 18, 54, 54, 12);
    ctx.fill();
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 38px system-ui";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText("✓", cardX + 73, stripY + 45);

    // Título transferencia
    const dirTxt = `Transferencia ${op.from || ROUTES[op.direccion]?.from || ""} → ${op.to || ROUTES[op.direccion]?.to || ""}`;
    ctx.fillStyle = "#0f172a";
    ctx.textAlign="left";
    ctx.textBaseline="middle";
    const titleX = cardX + 115;
    const titleY = stripY + (stripH/2);
    const maxTitleW = (cardX + cardW - 44) - titleX - 18;
    const baseTitleFont = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    fitText(ctx, dirTxt, maxTitleW, baseTitleFont);
    ctx.fillText(dirTxt, titleX, titleY);

    // Tabla (blanca)
    const tableTop = stripY + stripH + gapAfterStrip;
    const tableLeft = cardX + 26;
    const tableW = cardW - 52;
    const colW = tableW/2;

    ctx.fillStyle = "#ffffff";
    roundRectPath(ctx, tableLeft, tableTop, tableW, tableH, 18);
    ctx.fill();

    ctx.strokeStyle="#cfd8e3";
    ctx.lineWidth=4;
    roundRectPath(ctx, tableLeft, tableTop, tableW, tableH, 18);
    ctx.stroke();

    // líneas
    for(let i=1;i<rows.length;i++){
      const y = tableTop + i*rowH;
      ctx.beginPath();
      ctx.moveTo(tableLeft, y);
      ctx.lineTo(tableLeft+tableW, y);
      ctx.stroke();
    }
    ctx.beginPath();
    ctx.moveTo(tableLeft+colW, tableTop);
    ctx.lineTo(tableLeft+colW, tableTop+tableH);
    ctx.stroke();

    // texto tabla
    ctx.textBaseline="middle";
    for(let i=0;i<rows.length;i++){
      const yMid = tableTop + i*rowH + rowH/2;

      // etiqueta
      ctx.fillStyle="#0f172a";
      ctx.textAlign="left";
      const labelFont = "700 30px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      fitText(ctx, rows[i][0], colW-34, labelFont);
      ctx.fillText(rows[i][0], tableLeft+22, yMid);

      // valor
      ctx.fillStyle="#1d4ed8";
      ctx.textAlign="left";
      const valueFont = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      fitText(ctx, rows[i][1], colW-34, valueFont);
      ctx.fillText(rows[i][1], tableLeft+colW+22, yMid);
    }

    return c.toDataURL("image/png");
  }

  // ========= STORAGE =========
  const STORAGE_KEY = "ridmanpay_ops_v2";

  function loadOps(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }
  function saveOps(ops){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(ops));
  }

  // ========= UI =========
  function openReceiptModal(op){
    currentOp = op;

    const from = op.from || ROUTES[op.direccion]?.from || "—";
    const to = op.to || ROUTES[op.direccion]?.to || "—";
    $("pillDir").textContent = `✅ Transferencia ${from} → ${to}`;

    $("txtRecibo").textContent = buildReceiptText(op);

    currentDataUrl = drawReceiptToCanvas(op);
    $("imgRecibo").src = currentDataUrl;

    const fileBase = `ridmanpay_${op.fecha}_${from}-${to}_${op.monedaEntrega}_${String(op.entrega).replace(".","_")}${(op.cliente||"")?("_"+(op.cliente||"").trim().replace(/\s+/g,"_")):""}.png`;
    $("smallNote").textContent = `Archivo sugerido: ${fileBase}`;

    $("modalBack").style.display = "flex";
  }

  function closeModal(){
    $("modalBack").style.display = "none";
  }

  function renderHistory(){
    const ops = loadOps();
    const box = $("historial");
    box.innerHTML = "";

    if(!ops.length){
      box.innerHTML = `<div style="color:#6b7480; font-weight:900; padding:8px 2px">Aún no hay registros.</div>`;
      return;
    }

    ops.slice().reverse().forEach(op=>{
      const from = op.from || ROUTES[op.direccion]?.from || "—";
      const to = op.to || ROUTES[op.direccion]?.to || "—";
      const title = `${op.fecha} — ${from} → ${to} — ${op.monedaEntrega} ${op.entrega}`;
      const sub = `Imp USD: ${op.importeUSD} | Com: ${op.comisionUSD} | Enviar: ${op.montoEnviarUSD}`;

      const row = document.createElement("div");
      row.className="item";
      row.innerHTML = `
        <div class="meta">
          <div class="t">${title}</div>
          <div class="s">${sub}${(op.cliente||"") ? " | " + op.cliente : ""}</div>
        </div>
        <div class="actions">
          <button class="mini" data-act="open">Abrir</button>
          <button class="mini" data-act="copy">Copiar</button>
          <button class="mini" data-act="del">Eliminar</button>
        </div>
      `;

      row.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          const act = b.getAttribute("data-act");
          if(act==="open") openReceiptModal(op);
          if(act==="copy"){
            navigator.clipboard.writeText(buildReceiptText(op));
            alert("✅ Texto copiado");
          }
          if(act==="del"){
            const all = loadOps();
            saveOps(all.filter(x=>x.id !== op.id));
            renderHistory();
          }
        });
      });

      box.appendChild(row);
    });
  }

  let currentOp = null;
  let currentDataUrl = null;

  // ========= BUTTONS =========
  function clearInputs(){
    $("entrega").value = "";
    $("cliente").value = "";
    $("obs").value = "";
    $("modoComision").value = "AUTO";
    $("wrapComisionManual").style.display = "none";
    $("comisionManual").value = "";
  }

  async function downloadImage(){
    if(!currentDataUrl) return;
    const a = document.createElement("a");
    a.href = currentDataUrl;
    a.download = "ridmanpay.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function shareImage(){
    if(!currentDataUrl) return;

    // convertir dataURL -> blob
    const res = await fetch(currentDataUrl);
    const blob = await res.blob();
    const file = new File([blob], "ridmanpay.png", {type:"image/png"});

    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:"Ridman Pay"});
    } else {
      alert("En este equipo no está disponible compartir directo. Usa 'Descargar imagen'.");
    }
  }

  // ========= INIT =========
  $("fecha").value = todayISO();
  applyRouteUI();

  $("direccion").addEventListener("change", ()=>{
    applyRouteUI();
  });

  $("modoComision").addEventListener("change", ()=>{
    $("wrapComisionManual").style.display = ($("modoComision").value==="MANUAL") ? "block" : "none";
  });

  $("btnClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{
    if(e.target === $("modalBack")) closeModal();
  });

  $("btnCopiarModal").addEventListener("click", ()=>{
    if(!currentOp) return;
    navigator.clipboard.writeText(buildReceiptText(currentOp));
    alert("✅ Texto copiado");
  });

  $("btnDescargarImg").addEventListener("click", downloadImage);
  $("btnShareImg").addEventListener("click", shareImage);

  $("btnPreview").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    openReceiptModal(op);
  });

  $("btnCopiarTexto").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    navigator.clipboard.writeText(buildReceiptText(op));
    alert("✅ Texto copiado");
  });

  $("btnGuardarAbrir").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    const ops = loadOps();
    ops.push(op);
    saveOps(ops);
    renderHistory();
    openReceiptModal(op);
  });

  $("btnNuevo").addEventListener("click", clearInputs);

  $("btnBorrarTodo").addEventListener("click", ()=>{
    if(confirm("¿Seguro que deseas borrar todo el historial?")){
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      alert("✅ Listo, historial borrado");
    }
  });

  $("btnCsv").addEventListener("click", ()=>{
    const ops = loadOps();
    if(!ops.length){ alert("No hay registros para exportar."); return; }

    const headers = [
      "fecha","direccion","monedaEntrega","entrega","tasa1","tasa2",
      "importeUSD","comisionUSD","montoEnviarUSD","recibeCur","recibeText","cliente","obs"
    ];

    const lines = [headers.join(",")];
    ops.forEach(op=>{
      const row = headers.map(h=>{
        const v = (op[h] ?? "").toString().replaceAll('"','""');
        return `"${v}"`;
      });
      lines.push(row.join(","));
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ridmanpay_export.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  renderHistory();

  // ========= SERVICE WORKER (con versión para NO quedarse pegado) =========
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js?v=13").catch(()=>{});
  }
</script>

</body>
</html>
