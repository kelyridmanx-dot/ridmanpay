<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0aa7c7" />
  <title>Ridman Pay</title>

  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#dbe5f1;
      --blue:#0aa7c7;
      --blue2:#0ea5e9;
      --deep:#2f6fa3;
      --ok:#16a34a;
      --value:#1d4ed8;
      --shadow: 0 12px 35px rgba(2,6,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 28px;}
    .top{
      background:linear-gradient(180deg,#12b0ee,#0aa7c7);
      border-radius:26px;
      padding:28px 18px;
      box-shadow:var(--shadow);
      text-align:center;
      color:#fff;
      margin:8px 0 18px;
    }
    .top .t1{font-weight:900;letter-spacing:.35em;font-size:42px;}
    .top .t2{margin-top:10px;font-weight:700;opacity:.95;font-size:18px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(219,229,241,.7);
      padding:16px;
      margin-bottom:16px;
    }
    h1{
      margin:8px 0 14px;
      font-size:54px;
      line-height:1;
      font-weight:900;
    }
    .tip{
      display:flex;gap:12px;
      border-radius:14px;
      background:#e7f6ff;
      border:2px solid #b9e6ff;
      padding:14px;
      margin-bottom:14px;
      font-weight:700;
    }
    .grid{display:grid;gap:12px;}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
    @media(max-width:720px){
      h1{font-size:44px}
      .top .t1{font-size:32px;letter-spacing:.25em}
      .grid2{grid-template-columns:1fr}
    }
    label{display:block;margin:0 0 6px;color:var(--muted);font-weight:900}
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:70px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .primary{background:var(--blue2);border-color:transparent;color:#fff}
    .primary:hover{filter:brightness(.95)}
    .danger{background:#fee2e2;border-color:#fecaca}
    .share{
      border-radius:14px;
      background:#e7f6ff;
      border:1px solid #b9e6ff;
      padding:14px;
      margin-bottom:12px;
    }
    .share h3{margin:0 0 10px;text-align:center}
    .share p{margin:0;font-weight:700}
    .hist .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      background:#fff;
      align-items:center;
    }
    .hist .t{font-weight:900}
    .hist .s{color:var(--muted);font-weight:800;margin-top:4px}
    .mini{padding:10px 12px;border-radius:10px}
    /* Modal */
    .back{
      position:fixed;inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(960px, 100%);
      background:#fff;
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .pill{font-weight:900}
    .close{font-size:20px;padding:10px 12px}
    .modalGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:900px){.modalGrid{grid-template-columns:1fr}}
    pre{
      margin:0;
      background:#0b1220;
      color:#e2e8f0;
      border-radius:14px;
      padding:12px;
      overflow:auto;
      font-size:13px;
      line-height:1.35;
      min-height:240px;
    }
    .imgBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:grid;
      place-items:center;
      background:#fff;
    }
    img{max-width:100%;height:auto;display:block}
    canvas{display:none}
    small{color:var(--muted);font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="t1">RIDMAN PAY</div>
      <div class="t2">Cotización de transferencia</div>
    </div>

    <div class="card">
      <h1>Nueva operación</h1>

      <div class="tip">
        <div>⚠️</div>
        <div>
          Tip: si el cliente entrega <b>SOLES</b>, normalmente usa tipo de cambio <b>ALTO</b> (venta).
          Si entrega <b>DÓLARES</b>, usa tipo de cambio <b>BAJO</b> (compra).
          Si entrega <b>RUBLOS</b>, usamos tasa <b>RUB → USD</b>.
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Dirección</label>
          <select id="direccion">
            <option value="PE_RU">Perú → Rusia</option>
            <option value="RU_PE">Rusia → Perú</option>
            <option value="RU_CO">Rusia → Colombia</option>
          </select>
        </div>

        <div>
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>

        <div>
          <label>Moneda de entrega</label>
          <select id="monedaEntrega"></select>
        </div>

        <div>
          <label>Entrega</label>
          <input id="entrega" type="number" step="0.01" inputmode="decimal" placeholder="0.00">
        </div>

        <div class="grid2">
          <div>
            <label id="lblTasaOrigen">Tasa origen</label>
            <input id="tasaOrigen" type="number" step="0.0001" inputmode="decimal" placeholder="3.9800">
          </div>
          <div>
            <label id="lblTasaDestino">Tasa destino</label>
            <input id="tasaDestino" type="number" step="0.0001" inputmode="decimal" placeholder="79.5000">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Comisión</label>
            <select id="modoComision">
              <option value="AUTO">Automático</option>
              <option value="MANUAL">Manual</option>
            </select>
            <div id="wrapComisionManual" style="display:none;margin-top:10px">
              <input id="comisionManual" type="number" step="0.01" inputmode="decimal" placeholder="10.00">
            </div>
          </div>
          <div>
            <label>Cliente</label>
            <input id="cliente" type="text" placeholder="MARIA">
          </div>
        </div>

        <div>
          <label>Observación</label>
          <textarea id="obs" placeholder="(Opcional)"></textarea>
        </div>

        <div class="btns">
          <button class="primary" id="btnGuardarAbrir">Guardar y abrir</button>
          <button id="btnPreview">Vista previa</button>
          <button id="btnCopiarTexto">Copiar texto</button>
          <button id="btnNuevo">Nuevo</button>
          <button id="btnCsv">Exportar CSV</button>
          <button class="danger" id="btnBorrarTodo">Borrar todo</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="share">
        <h3>Reenviar como IMAGEN (WhatsApp / Telegram)</h3>
        <p>Si estás en laptop y no aparece “compartir”, usa Descargar imagen y la envías por WhatsApp Web / Telegram Desktop.</p>
      </div>

      <div class="hist">
        <div id="historial"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="pill" id="pillDir">✅ Transferencia</div>
        <button class="close" id="btnClose">✕</button>
      </div>

      <div class="modalGrid">
        <div>
          <pre id="txtRecibo"></pre>
          <div class="btns" style="margin-top:10px">
            <button id="btnCopiarModal">Copiar texto</button>
            <button class="primary" id="btnDescargarImg">Descargar imagen</button>
            <button class="primary" id="btnShareImg">Compartir imagen</button>
          </div>
          <small id="smallNote"></small>
        </div>

        <div class="imgBox">
          <img id="imgRecibo" alt="Vista previa (imagen)">
          <canvas id="canvasRecibo" width="1080" height="1400"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const round2 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;
  const round4 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 10000) / 10000;

  const fmt2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtRate2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});

  // RUB en recibe: entero y mostrar .00 (como pediste)
  const fmtRubRecibe = (n)=>{
    const roundedInt = Math.round(Number(n||0));
    return roundedInt.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  };

  function todayISO(){
    const d = new Date();
    const pad=(x)=>String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  // Tabla de direcciones (según tu lógica)
  // entregaCurrencies: qué monedas puede entregar el cliente en esa dirección
  // destCur: moneda final que recibe el destinatario
  // tasaDestino: siempre USD -> destCur
  // tasaOrigen: depende de monedaEntrega (PEN->USD o RUB->USD)
  const ROUTES = {
    PE_RU: { label:"Transferencia Perú → Rusia", entregaCurrencies:["PEN","USD"], destCur:"RUB" },
    RU_PE: { label:"Transferencia Rusia → Perú", entregaCurrencies:["RUB","USD"], destCur:"PEN" },
    RU_CO: { label:"Transferencia Rusia → Colombia", entregaCurrencies:["RUB","USD"], destCur:"COP" },
  };

  function curLabel(cur){
    if(cur==="PEN") return "PEN (Soles)";
    if(cur==="USD") return "USD (Dólares)";
    if(cur==="RUB") return "RUB (Rublo)";
    if(cur==="COP") return "COP (Peso colombiano)";
    return cur;
  }

  function curPrefix(cur){
    if(cur==="PEN") return "S/ ";
    if(cur==="USD") return "USD ";
    if(cur==="RUB") return "RUB ";
    if(cur==="COP") return "COP ";
    return "";
  }

  function calcCommissionUSD(importeUSD){
    const x = Number(importeUSD||0);
    const eps = 1e-9;
    if(x <= 300 + eps) return 10;
    if(x <= 600 + eps) return 15;
    if(x <= 1000 + eps) return 25;
    if(x <= 1600 + eps) return 30;
    return round2(x * 0.017);
  }

  function refreshCurrencyOptions(){
    const dir = $("direccion").value;
    const r = ROUTES[dir];

    // options
    const sel = $("monedaEntrega");
    const current = sel.value;
    sel.innerHTML = "";
    r.entregaCurrencies.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = curLabel(c);
      sel.appendChild(opt);
    });

    // mantener selección si existe
    if(r.entregaCurrencies.includes(current)) sel.value = current;

    updateRateLabels();
  }

  function updateRateLabels(){
    const dir = $("direccion").value;
    const r = ROUTES[dir];
    const me = $("monedaEntrega").value;

    // Tasa ORIGEN: solo si entrega no es USD
    if(me==="USD"){
      $("lblTasaOrigen").textContent = "Tasa origen (no aplica si entrega USD)";
      $("tasaOrigen").disabled = true;
      $("tasaOrigen").value = "";
      $("tasaOrigen").placeholder = "—";
    } else if(me==="PEN"){
      $("lblTasaOrigen").textContent = "Tasa Perú (PEN → USD)";
      $("tasaOrigen").disabled = false;
      if(!$("tasaOrigen").value) $("tasaOrigen").placeholder = "3.9800";
    } else if(me==="RUB"){
      $("lblTasaOrigen").textContent = "Tasa Rusia (RUB → USD)";
      $("tasaOrigen").disabled = false;
      if(!$("tasaOrigen").value) $("tasaOrigen").placeholder = "0.0112";
    } else {
      $("lblTasaOrigen").textContent = "Tasa origen";
      $("tasaOrigen").disabled = false;
    }

    // Tasa DESTINO siempre USD -> moneda destino
    $("lblTasaDestino").textContent = `Tasa destino (USD → ${r.destCur})`;
    if(!$("tasaDestino").value){
      // placeholders típicos, puedes cambiar
      $("tasaDestino").placeholder = (r.destCur==="RUB") ? "79.5000" : (r.destCur==="PEN") ? "3.9800" : "3900.00";
    }
  }

  function computeOperationFromInputs(){
    const dir = $("direccion").value;
    const r = ROUTES[dir];

    const fecha = $("fecha").value || todayISO();
    const monedaEntrega = $("monedaEntrega").value;
    const entrega = Number($("entrega").value || 0);

    const tasaOrigen = Number($("tasaOrigen").value || 0);   // PEN->USD o RUB->USD (según monedaEntrega)
    const tasaDestino = Number($("tasaDestino").value || 0); // USD->RUB/PEN/COP

    const cliente = ($("cliente").value || "").trim();
    const obs = ($("obs").value || "").trim();

    // 1) convertir entrega a USD
    let importeUSD = 0;
    if(monedaEntrega==="USD"){
      importeUSD = entrega;
    }else{
      // entrega / (moneda->USD)  si tasa es "PEN por 1 USD" o "RUB por 1 USD"
      // En tus pantallas: "1 USD = X PEN" y "1 USD = X RUB"
      // Entonces: USD = entrega / X
      importeUSD = (tasaOrigen>0) ? (entrega / tasaOrigen) : 0;
    }

    // 2) comisión USD
    const comMode = $("modoComision").value;
    let comisionUSD = 0;
    if(comMode === "MANUAL"){
      comisionUSD = Number($("comisionManual").value || 0);
    } else {
      comisionUSD = calcCommissionUSD(importeUSD);
    }

    // 3) monto a enviar en USD
    const montoEnviarUSD = Math.max(0, importeUSD - comisionUSD);

    // 4) recibe en moneda destino
    let recibeText = "";
    if(r.destCur==="RUB"){
      const recibeRUB = montoEnviarUSD * tasaDestino;
      recibeText = `${fmtRubRecibe(recibeRUB)} rublos`;
    }else{
      const recibe = montoEnviarUSD * tasaDestino;
      recibeText = `${curPrefix(r.destCur)}${fmt2(recibe)} (${r.destCur})`;
    }

    return {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
      direccion: dir,
      dirLabel: r.label,
      fecha,
      monedaEntrega,
      entrega: round2(entrega),
      tasaOrigen: round4(tasaOrigen),
      tasaDestino: round4(tasaDestino),
      destCur: r.destCur,
      cliente,
      obs,
      importeUSD: round2(importeUSD),
      comisionUSD: round2(comisionUSD),
      montoEnviarUSD: round2(montoEnviarUSD),
      recibeText
    };
  }

  // ORDEN DEL TEXTO (como tu imagen 2):
  // Fecha -> Entrega -> Tasa Origen -> Importe USD -> Comisión -> Monto a enviar -> Tasa Destino -> Recibe -> Cliente
  function buildReceiptText(op){
    const lines = [];
    lines.push(`✅ ${op.dirLabel}`);
    lines.push(`Fecha: ${op.fecha}`);

    lines.push(`Entrega: ${curPrefix(op.monedaEntrega)}${fmt2(op.entrega)} (${op.monedaEntrega})`);

    if(op.monedaEntrega !== "USD"){
      const tasaLabel = (op.monedaEntrega==="PEN") ? "Tasa PEN → USD" : "Tasa RUB → USD";
      lines.push(`${tasaLabel}: 1 USD = ${fmtRate2(op.tasaOrigen)} ${op.monedaEntrega}`);
    }

    lines.push(`Importe (USD): USD ${fmt2(op.importeUSD)} USD`);
    lines.push(`Comisión: USD ${fmt2(op.comisionUSD)}`);
    lines.push(`Monto a enviar: USD ${fmt2(op.montoEnviarUSD)} USD`);

    // tasa destino
    lines.push(`Tasa USD → ${op.destCur}: 1 USD = ${fmtRate2(op.tasaDestino)} ${op.destCur}`);

    lines.push(`Recibe: ${op.recibeText}`);

    if(op.cliente) lines.push(`Cliente: ${op.cliente}`);
    if(op.obs) lines.push(`Obs: ${op.obs}`);

    return lines.join("\n");
  }

  // Canvas helper
  function rr(ctx,x,y,w,h,r){
    const radius = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+radius,y);
    ctx.arcTo(x+w,y,x+w,y+h,radius);
    ctx.arcTo(x+w,y+h,x,y+h,radius);
    ctx.arcTo(x,y+h,x,y,radius);
    ctx.arcTo(x,y,x+w,y,radius);
    ctx.closePath();
  }

  function fitTitle(ctx, text, maxWidth){
    // baja tamaño si es largo (para Rusia → Colombia)
    let size = 52;
    while(size >= 28){
      ctx.font = `900 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      if(ctx.measureText(text).width <= maxWidth) return size;
      size -= 2;
    }
    return 28;
  }

  function drawReceiptToCanvas(op){
    const c = $("canvasRecibo");
    const ctx = c.getContext("2d");

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,c.width,c.height);

    // fondo blanco
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,c.width,c.height);

    const pad = 56;
    const cardX = pad;
    const cardY = pad;
    const cardW = c.width - pad*2;
    const cardH = c.height - pad*2;

    // sombra suave
    ctx.save();
    ctx.fillStyle = "rgba(15,23,42,.08)";
    rr(ctx, cardX+8, cardY+12, cardW, cardH, 28);
    ctx.fill();
    ctx.restore();

    // tarjeta
    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#dbe5f1";
    ctx.lineWidth = 4;
    rr(ctx, cardX, cardY, cardW, cardH, 28);
    ctx.fill();
    ctx.stroke();

    // header AZUL (solo arriba)
    const headerH = 190;
    ctx.fillStyle = "#2f6fa3";
    rr(ctx, cardX, cardY, cardW, headerH, 28);
    ctx.fill();

    // Título "Ridman Pay"
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 86px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "alphabetic";
    ctx.fillText("Ridman Pay", cardX + cardW/2, cardY + 122);

    // línea bajo header
    ctx.strokeStyle = "#dbe5f1";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(cardX, cardY + headerH);
    ctx.lineTo(cardX + cardW, cardY + headerH);
    ctx.stroke();

    // banda blanca del contenido (para que no quede azul abajo)
    const contentTop = cardY + headerH;
    const contentH = cardH - headerH;
    ctx.fillStyle = "#ffffff";
    rr(ctx, cardX, contentTop, cardW, contentH, 0);
    ctx.fill();

    // fila título transferencia (check + texto)
    const titleY = cardY + headerH + 78;

    // check verde
    ctx.fillStyle = "#16a34a";
    rr(ctx, cardX + 34, titleY - 48, 72, 72, 14);
    ctx.fill();
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 46px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("✓", cardX + 70, titleY + 8);

    // texto dirección (auto-ajuste)
    ctx.fillStyle = "#0f172a";
    ctx.textAlign = "left";
    const maxTitleW = cardW - 34 - 34 - 72 - 24;
    const usedSize = fitTitle(ctx, op.dirLabel, maxTitleW);
    ctx.font = `900 ${usedSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText(op.dirLabel, cardX + 130, titleY + 8);

    // tabla
    const tableTop = titleY + 54;
    const tableLeft = cardX + 26;
    const tableW = cardW - 52;
    const colW = tableW/2;

    // filas en orden (como tu imagen 2)
    const rows = [];
    rows.push(["Fecha:", op.fecha]);
    rows.push(["Entrega:", `${curPrefix(op.monedaEntrega)}${fmt2(op.entrega)} (${op.monedaEntrega})`]);

    if(op.monedaEntrega !== "USD"){
      const tasaLabel = (op.monedaEntrega==="PEN") ? "Tasa PEN → USD" : "Tasa RUB → USD";
      rows.push([tasaLabel, `1 USD = ${fmtRate2(op.tasaOrigen)} ${op.monedaEntrega}`]);
    }

    rows.push(["Importe (USD):", `USD ${fmt2(op.importeUSD)} USD`]);
    rows.push(["Comisión:", `USD ${fmt2(op.comisionUSD)}`]);
    rows.push(["Monto a enviar:", `USD ${fmt2(op.montoEnviarUSD)} USD`]);

    rows.push([`Tasa USD → ${op.destCur}`, `1 USD = ${fmtRate2(op.tasaDestino)} ${op.destCur}`]);
    rows.push(["Recibe:", op.recibeText]);

    if(op.cliente) rows.push(["Cliente:", op.cliente.toUpperCase()]);
    if(op.obs) rows.push(["Obs:", op.obs]);

    const rowH = 104;
    const tableH = rows.length * rowH;

    ctx.fillStyle = "#ffffff";
    rr(ctx, tableLeft, tableTop, tableW, tableH, 18);
    ctx.fill();

    ctx.strokeStyle="#cfd8e3";
    ctx.lineWidth=4;
    rr(ctx, tableLeft, tableTop, tableW, tableH, 18);
    ctx.stroke();

    // líneas
    ctx.beginPath();
    ctx.moveTo(tableLeft + colW, tableTop);
    ctx.lineTo(tableLeft + colW, tableTop + tableH);
    for(let i=1;i<rows.length;i++){
      ctx.moveTo(tableLeft, tableTop + i*rowH);
      ctx.lineTo(tableLeft + tableW, tableTop + i*rowH);
    }
    ctx.stroke();

    // texto tabla
    for(let i=0;i<rows.length;i++){
      const y = tableTop + i*rowH;

      // label
      ctx.fillStyle = "#0f172a";
      ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign="left";
      ctx.fillText(rows[i][0], tableLeft + 22, y + 66);

      // value
      ctx.fillStyle = "#1d4ed8";
      ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(rows[i][1], tableLeft + colW + 22, y + 66);
    }
  }

  function canvasToPngDataUrl(){
    return $("canvasRecibo").toDataURL("image/png");
  }

  function suggestedFilename(op){
    const safe = (s)=>String(s||"").replace(/[^\w\-]+/g,"_");
    const dir = op.dirLabel.replace(/\s+/g,"-").replace(/[→]/g,"-");
    const client = op.cliente ? "_" + safe(op.cliente) : "";
    return `ridmanpay_${op.fecha}_${safe(dir)}_${op.monedaEntrega}_${safe(op.entrega)}${client}.png`;
  }

  function saveHistory(op){
    const key="ridmanpay_ops_v2";
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.unshift(op);
    localStorage.setItem(key, JSON.stringify(arr.slice(0,50)));
  }

  function loadHistory(){
    const key="ridmanpay_ops_v2";
    return JSON.parse(localStorage.getItem(key) || "[]");
  }

  function renderHistory(){
    const el = $("historial");
    const arr = loadHistory();
    if(arr.length===0){
      el.innerHTML = `<div class="s" style="color:var(--muted);font-weight:800">Aún no hay operaciones guardadas.</div>`;
      return;
    }
    el.innerHTML = "";
    arr.forEach(op=>{
      const wrap = document.createElement("div");
      wrap.className="item";
      wrap.innerHTML = `
        <div>
          <div class="t">${op.fecha} — ${op.dirLabel}</div>
          <div class="s">Entrega: ${curPrefix(op.monedaEntrega)}${fmt2(op.entrega)} (${op.monedaEntrega}) | Imp USD: ${fmt2(op.importeUSD)} | Com: ${fmt2(op.comisionUSD)} | Enviar: ${fmt2(op.montoEnviarUSD)}</div>
        </div>
        <div class="btns" style="margin:0">
          <button class="mini" data-act="abrir" data-id="${op.id}">Abrir</button>
          <button class="mini" data-act="copiar" data-id="${op.id}">Copiar</button>
          <button class="mini danger" data-act="eliminar" data-id="${op.id}">Eliminar</button>
        </div>
      `;
      el.appendChild(wrap);
    });

    el.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        const arr = loadHistory();
        const op = arr.find(x=>x.id===id);
        if(act==="eliminar"){
          const filtered = arr.filter(x=>x.id!==id);
          localStorage.setItem("ridmanpay_ops_v2", JSON.stringify(filtered));
          renderHistory();
          return;
        }
        if(!op) return;
        if(act==="copiar"){
          navigator.clipboard.writeText(buildReceiptText(op)).catch(()=>{});
          return;
        }
        if(act==="abrir"){
          openModalWith(op);
          return;
        }
      });
    });
  }

  function openModalWith(op){
    $("pillDir").textContent = `✅ ${op.dirLabel}`;
    const txt = buildReceiptText(op);
    $("txtRecibo").textContent = txt;

    drawReceiptToCanvas(op);
    const url = canvasToPngDataUrl();
    $("imgRecibo").src = url;

    $("smallNote").textContent = `Archivo sugerido: ${suggestedFilename(op)}`;

    $("modalBack").style.display = "flex";

    // botones modal
    $("btnCopiarModal").onclick = ()=>navigator.clipboard.writeText(txt).catch(()=>{});

    $("btnDescargarImg").onclick = ()=>{
      const a = document.createElement("a");
      a.href = url;
      a.download = suggestedFilename(op);
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    $("btnShareImg").onclick = async ()=>{
      try{
        // convertir dataURL a blob
        const res = await fetch(url);
        const blob = await res.blob();
        const file = new File([blob], suggestedFilename(op), {type:"image/png"});
        if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
          await navigator.share({files:[file], title:"Ridman Pay"});
          return;
        }
        // fallback: descargar
        const a = document.createElement("a");
        a.href = url;
        a.download = suggestedFilename(op);
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){
        // fallback copiar texto
        navigator.clipboard.writeText(txt).catch(()=>{});
      }
    };
  }

  // Eventos
  $("modoComision").addEventListener("change", ()=>{
    $("wrapComisionManual").style.display = ($("modoComision").value==="MANUAL") ? "block" : "none";
  });

  $("direccion").addEventListener("change", ()=>{
    refreshCurrencyOptions();
  });

  $("monedaEntrega").addEventListener("change", ()=>{
    updateRateLabels();
  });

  $("btnClose").addEventListener("click", ()=> $("modalBack").style.display="none");
  $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") $("modalBack").style.display="none"; });

  $("btnPreview").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    openModalWith(op);
  });

  $("btnGuardarAbrir").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    saveHistory(op);
    renderHistory();
    openModalWith(op);
  });

  $("btnCopiarTexto").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    navigator.clipboard.writeText(buildReceiptText(op)).catch(()=>{});
  });

  $("btnNuevo").addEventListener("click", ()=>{
    $("entrega").value = "";
    $("cliente").value = "";
    $("obs").value = "";
  });

  $("btnBorrarTodo").addEventListener("click", ()=>{
    localStorage.removeItem("ridmanpay_ops_v2");
    renderHistory();
  });

  $("btnCsv").addEventListener("click", ()=>{
    const arr = loadHistory();
    if(arr.length===0) return;

    const headers = [
      "fecha","direccion","moneda_entrega","entrega","tasa_origen","tasa_destino","importe_usd","comision_usd","monto_enviar_usd","recibe","cliente","obs"
    ];
    const lines = [headers.join(",")];

    arr.forEach(op=>{
      const row = [
        op.fecha,
        `"${op.dirLabel.replace(/"/g,'""')}"`,
        op.monedaEntrega,
        op.entrega,
        op.tasaOrigen,
        op.tasaDestino,
        op.importeUSD,
        op.comisionUSD,
        op.montoEnviarUSD,
        `"${String(op.recibeText).replace(/"/g,'""')}"`,
        `"${String(op.cliente||"").replace(/"/g,'""')}"`,
        `"${String(op.obs||"").replace(/"/g,'""')}"`
      ];
      lines.push(row.join(","));
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ridmanpay_historial.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Init
  $("fecha").value = todayISO();
  refreshCurrencyOptions();
  renderHistory();

  // Registrar Service Worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }
</script>
</body>
</html>
