<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0aa7c7" />
  <title>Ridman Pay</title>

  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#dbe5f1;
      --blue:#0aa7c7;
      --blue2:#0ea5e9;
      --deep:#2f6fa3;
      --ok:#16a34a;
      --value:#1d4ed8;
      --shadow: 0 12px 35px rgba(2,6,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 28px;}
    .top{
      background:linear-gradient(180deg,#12b0ee,#0aa7c7);
      border-radius:26px;
      padding:28px 18px;
      box-shadow:var(--shadow);
      text-align:center;
      color:#fff;
      margin:8px 0 18px;
    }
    .top .t1{font-weight:900;letter-spacing:.35em;font-size:42px;}
    .top .t2{margin-top:10px;font-weight:700;opacity:.95;font-size:18px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(219,229,241,.7);
      padding:16px;
      margin-bottom:16px;
    }
    h1{
      margin:8px 0 14px;
      font-size:54px;
      line-height:1;
      font-weight:900;
    }
    .tip{
      display:flex;gap:12px;
      border-radius:14px;
      background:#e7f6ff;
      border:2px solid #b9e6ff;
      padding:14px;
      margin-bottom:14px;
      font-weight:700;
    }
    .grid{display:grid;gap:12px;}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
    @media(max-width:720px){
      h1{font-size:44px}
      .top .t1{font-size:32px;letter-spacing:.25em}
      .grid2{grid-template-columns:1fr}
    }
    label{display:block;margin:0 0 6px;color:var(--muted);font-weight:900}
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:70px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .primary{background:var(--blue2);border-color:transparent;color:#fff}
    .primary:hover{filter:brightness(.95)}
    .danger{background:#fee2e2;border-color:#fecaca}
    .share{
      border-radius:14px;
      background:#e7f6ff;
      border:1px solid #b9e6ff;
      padding:14px;
      margin-bottom:12px;
    }
    .share h3{margin:0 0 10px;text-align:center}
    .share p{margin:0;font-weight:700}
    .hist .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      background:#fff;
    }
    .hist .t{font-weight:900}
    .hist .s{color:var(--muted);font-weight:800;margin-top:4px}
    .mini{padding:10px 12px;border-radius:10px}
    /* Modal */
    .back{
      position:fixed;inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(960px, 100%);
      background:#fff;
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .pill{font-weight:900}
    .close{font-size:20px;padding:10px 12px}
    .modalGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:900px){.modalGrid{grid-template-columns:1fr}}
    pre{
      margin:0;
      background:#0b1220;
      color:#e2e8f0;
      border-radius:14px;
      padding:12px;
      overflow:auto;
      font-size:13px;
      line-height:1.35;
      min-height:240px;
    }
    .imgBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:grid;
      place-items:center;
      background:#fff;
    }
    img{max-width:100%;height:auto;display:block}
    canvas{display:none}
    small{color:var(--muted);font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="t1">RIDMAN PAY</div>
      <div class="t2">Cotización de transferencia Perú - Rusia</div>
    </div>

    <div class="card">
      <h1>Nueva operación</h1>

      <div class="tip">
        <div>⚠️</div>
        <div>Tip: si el cliente entrega <b>SOLES</b>, normalmente usa el tipo de cambio <b>ALTO</b> (venta). Si entrega <b>DÓLARES</b>, usa el tipo de cambio <b>BAJO</b> (compra).</div>
      </div>

      <div class="grid">
        <div>
          <label>Dirección</label>
          <select id="direccion">
            <option value="PE_RU">Perú → Rusia</option>
            <option value="RU_PE">Rusia → Perú</option>
          </select>
        </div>

        <div>
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>

        <div>
          <label>Moneda de entrega</label>
          <select id="monedaEntrega">
            <option value="PEN">PEN (Soles)</option>
            <option value="USD">USD (Dólares)</option>
          </select>
        </div>

        <div>
          <label>Entrega</label>
          <input id="entrega" type="number" step="0.01" inputmode="decimal" placeholder="0.00">
        </div>

        <div class="grid2">
          <div>
            <label>Tasa Perú (PEN → USD)</label>
            <input id="tasaPeru" type="number" step="0.0001" inputmode="decimal" placeholder="3.9800">
          </div>
          <div>
            <label>Tasa Rusia (USD → RUB)</label>
            <input id="tasaRusia" type="number" step="0.0001" inputmode="decimal" placeholder="79.5000">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Comisión</label>
            <select id="modoComision">
              <option value="AUTO">Automático</option>
              <option value="MANUAL">Manual</option>
            </select>
            <div id="wrapComisionManual" style="display:none;margin-top:10px">
              <input id="comisionManual" type="number" step="0.01" inputmode="decimal" placeholder="10.00">
            </div>
          </div>
          <div>
            <label>Cliente</label>
            <input id="cliente" type="text" placeholder="MARIA">
          </div>
        </div>

        <div>
          <label>Observación</label>
          <textarea id="obs" placeholder="(Opcional)"></textarea>
        </div>

        <div class="btns">
          <button class="primary" id="btnGuardarAbrir">Guardar y abrir</button>
          <button id="btnPreview">Vista previa</button>
          <button id="btnCopiarTexto">Copiar texto</button>
          <button id="btnNuevo">Nuevo</button>
          <button id="btnCsv">Exportar CSV</button>
          <button class="danger" id="btnBorrarTodo">Borrar todo</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="share">
        <h3>Reenviar como IMAGEN (WhatsApp / Telegram)</h3>
        <p>Si estás en laptop y no aparece “compartir”, usa Descargar imagen y la envías por WhatsApp Web / Telegram Desktop.</p>
      </div>

      <div class="hist">
        <div id="historial"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="pill" id="pillDir">✅ Transferencia Perú → Rusia</div>
        <button class="close" id="btnClose">✕</button>
      </div>

      <div class="modalGrid">
        <div>
          <pre id="txtRecibo"></pre>
          <div class="btns" style="margin-top:10px">
            <button id="btnCopiarModal">Copiar texto</button>
            <button class="primary" id="btnDescargarImg">Descargar imagen</button>
            <button class="primary" id="btnShareImg">Compartir imagen</button>
          </div>
          <small id="smallNote"></small>
        </div>

        <div class="imgBox">
          <img id="imgRecibo" alt="Vista previa (imagen)">
          <canvas id="canvasRecibo" width="1080" height="1400"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const round2 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;
  const round4 = (n)=> Math.round((Number(n||0) + Number.EPSILON) * 10000) / 10000;

  // ✅ Formato general: siempre 2 decimales
  const fmt2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtRate2 = (n)=> Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});

  const moneyPrefix = (cur)=>{
    if(cur==="PEN") return "S/ ";
    if(cur==="USD") return "USD ";
    return "";
  };

  // ✅ RUBLOS: redondeo a entero (0.50 hacia arriba) y mostrar .00
  const fmtRubRecibe = (n)=>{
    const roundedInt = Math.round(Number(n||0)); // 10000.50 -> 10001
    return roundedInt.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  };

  function todayISO(){
    const d = new Date();
    const pad=(x)=>String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function calcCommissionUSD(importeUSD){
    const x = Number(importeUSD||0);
    const eps = 1e-9;
    if(x <= 300 + eps) return 10;
    if(x <= 600 + eps) return 15;
    if(x <= 1000 + eps) return 25;
    if(x <= 1600 + eps) return 30;
    return round2(x * 0.017);
  }

  function computeOperationFromInputs(){
    const direccion = $("direccion").value;
    const fecha = $("fecha").value || todayISO();
    const monedaEntrega = $("monedaEntrega").value;
    const entrega = Number($("entrega").value || 0);
    const tasaPeru = Number($("tasaPeru").value || 0);
    const tasaRusia = Number($("tasaRusia").value || 0);
    const cliente = ($("cliente").value || "").trim();
    const obs = ($("obs").value || "").trim();

    let importeUSD = 0;
    if(monedaEntrega === "PEN"){
      importeUSD = tasaPeru>0 ? (entrega / tasaPeru) : 0;
    } else {
      importeUSD = entrega;
    }

    const comMode = $("modoComision").value;
    let comisionUSD = 0;
    if(comMode === "MANUAL"){
      comisionUSD = Number($("comisionManual").value || 0);
    } else {
      comisionUSD = calcCommissionUSD(importeUSD);
    }

    const montoEnviarUSD = Math.max(0, importeUSD - comisionUSD);

    let recibeText = "";
    if(direccion === "PE_RU"){
      const recibeRUB = montoEnviarUSD * tasaRusia;
      // ✅ regla especial rublo
      recibeText = `${fmtRubRecibe(recibeRUB)} rublos`;
    } else {
      const recibePEN = montoEnviarUSD * tasaPeru;
      recibeText = `S/ ${fmt2(recibePEN)} (PEN)`;
    }

    const showTasaPenUsd = (monedaEntrega !== "USD");

    return {
      id: crypto.randomUUID(),
      direccion, fecha, monedaEntrega,
      entrega: round2(entrega),
      tasaPeru: round4(tasaPeru),
      tasaRusia: round4(tasaRusia),
      cliente, obs,
      showTasaPenUsd,
      importeUSD: round2(importeUSD),
      comisionUSD: round2(comisionUSD),
      montoEnviarUSD: round2(montoEnviarUSD),
      recibeText
    };
  }

  function buildReceiptText(op){
    const dirTxt = (op.direccion==="PE_RU") ? "Transferencia Perú → Rusia" : "Transferencia Rusia → Perú";
    const lines = [];
    lines.push(`✅ ${dirTxt}`);
    lines.push(`Entrega: ${op.monedaEntrega==="PEN" ? `S/ ${fmt2(op.entrega)} (PEN)` : `USD ${fmt2(op.entrega)} (USD)`}`);

    if(op.showTasaPenUsd){
      lines.push(`Tasa PEN → USD: 1 USD = ${fmtRate2(op.tasaPeru)} PEN`);
    }

    if(op.direccion==="PE_RU"){
      lines.push(`Tasa USD → RUB: 1 USD = ${fmtRate2(op.tasaRusia)} RUB`);
    } else {
      lines.push(`Tasa USD → PEN: 1 USD = ${fmtRate2(op.tasaPeru)} PEN`);
    }

    lines.push(`Importe (USD): USD ${fmt2(op.importeUSD)} USD`);
    lines.push(`Comisión: USD ${fmt2(op.comisionUSD)}`);
    lines.push(`Monto a enviar: USD ${fmt2(op.montoEnviarUSD)} USD`);
    lines.push(`Recibe: ${op.recibeText}`);

    if(op.cliente) lines.push(`Cliente: ${op.cliente}`);
    if(op.obs) lines.push(`Obs: ${op.obs}`);

    return lines.join("\n");
  }

  function fitText(ctx, text, maxWidth, baseFont){
    let size = Number((baseFont.match(/(\d+)px/)||[])[1] || 28);
    let weight = (baseFont.match(/^(\d+)\s/)||[])[1] || "600";
    const family = baseFont.replace(/^\d+\s+\d+px\s+/,"").replace(/^\d+px\s+/,"");
    while(size > 14){
      ctx.font = `${weight} ${size}px ${family}`;
      if(ctx.measureText(text).width <= maxWidth) break;
      size -= 1;
    }
  }

  function drawReceiptToCanvas(op){
    const c = $("canvasRecibo");
    const ctx = c.getContext("2d");

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,c.width,c.height);

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,c.width,c.height);

    const pad = 56;
    const cardX = pad;
    const cardY = pad;
    const cardW = c.width - pad*2;
    const cardH = c.height - pad*2;

    ctx.save();
    ctx.fillStyle = "rgba(15,23,42,.08)";
    ctx.roundRect(cardX+8, cardY+10, cardW, cardH, 28);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#dbe5f1";
    ctx.lineWidth = 4;
    ctx.roundRect(cardX, cardY, cardW, cardH, 28);
    ctx.fill();
    ctx.stroke();

    const headerH = 190;
    ctx.fillStyle = "#2f6fa3";
    ctx.roundRect(cardX, cardY, cardW, headerH, 28);
    ctx.fill();

    ctx.fillStyle = "#ffffff";
    ctx.font = "900 86px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.fillText("Ridman Pay", cardX + cardW/2, cardY + 120);

    ctx.strokeStyle = "#dbe5f1";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(cardX, cardY + headerH);
    ctx.lineTo(cardX+cardW, cardY + headerH);
    ctx.stroke();

    const titleY = cardY + headerH + 75;

    ctx.fillStyle = "#16a34a";
    ctx.roundRect(cardX + 34, titleY - 46, 72, 72, 14);
    ctx.fill();
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 46px system-ui";
    ctx.textAlign="center";
    ctx.fillText("✓", cardX + 70, titleY + 6);

    ctx.fillStyle = "#0f172a";
    ctx.font = "900 58px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="left";
    const dirTxt = (op.direccion==="PE_RU") ? "Transferencia Perú → Rusia" : "Transferencia Rusia → Perú";
    ctx.fillText(dirTxt, cardX + 130, titleY + 6);

    const tableTop = titleY + 44;
    const tableLeft = cardX + 26;
    const tableW = cardW - 52;
    const colW = tableW/2;

    const rows = [];
    rows.push(["Entrega:", op.monedaEntrega==="PEN" ? `S/ ${fmt2(op.entrega)} (PEN)` : `USD ${fmt2(op.entrega)} (USD)`]);

    if(op.showTasaPenUsd){
      rows.push(["Tasa PEN → USD", `1 USD = ${fmtRate2(op.tasaPeru)} PEN`]);
    }

    if(op.direccion==="PE_RU"){
      rows.push(["Tasa USD → RUB", `1 USD = ${fmtRate2(op.tasaRusia)} RUB`]);
    } else {
      rows.push(["Tasa USD → PEN", `1 USD = ${fmtRate2(op.tasaPeru)} PEN`]);
    }

    rows.push(["Importe (USD):", `USD ${fmt2(op.importeUSD)} USD`]);
    rows.push(["Comisión:", `USD ${fmt2(op.comisionUSD)}`]);
    rows.push(["Monto a enviar:", `USD ${fmt2(op.montoEnviarUSD)} USD`]);
    rows.push(["Recibe:", op.recibeText]);

    if(op.cliente) rows.push(["Cliente:", op.cliente.toUpperCase()]);
    if(op.obs) rows.push(["Obs:", op.obs]);

    const rowH = 112;
    const tableH = rows.length * rowH;

    ctx.fillStyle = "#ffffff";
    ctx.beginPath();
    ctx.roundRect(tableLeft, tableTop, tableW, tableH, 18);
    ctx.fill();

    ctx.strokeStyle="#cfd8e3";
    ctx.lineWidth=4;
    ctx.roundRect(tableLeft, tableTop, tableW, tableH, 18);
    ctx.stroke();

    for(let i=1;i<rows.length;i++){
      const y = tableTop + i*rowH;
      ctx.beginPath();
      ctx.moveTo(tableLeft, y);
      ctx.lineTo(tableLeft+tableW, y);
      ctx.stroke();
    }

    ctx.beginPath();
    ctx.moveTo(tableLeft+colW, tableTop);
    ctx.lineTo(tableLeft+colW, tableTop+tableH);
    ctx.stroke();

    ctx.textBaseline="middle";
    const labelFont = "600 30px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const valueFont = "800 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";

    for(let i=0;i<rows.length;i++){
      const yMid = tableTop + i*rowH + rowH/2;

      ctx.fillStyle="#0f172a";
      ctx.textAlign="left";
      fitText(ctx, rows[i][0], colW-34, labelFont);
      ctx.fillText(rows[i][0], tableLeft+22, yMid);

      ctx.fillStyle="#1d4ed8";
      ctx.textAlign="left";
      fitText(ctx, rows[i][1], colW-34, valueFont);
      ctx.fillText(rows[i][1], tableLeft+colW+22, yMid);
    }

    return c.toDataURL("image/png");
  }

  const STORAGE_KEY = "ridmanpay_ops_v1";

  function loadOps(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }
  function saveOps(ops){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(ops));
  }

  function renderHistory(){
    const ops = loadOps();
    const box = $("historial");
    box.innerHTML = "";

    if(!ops.length){
      box.innerHTML = `<div style="color:#6b7480; font-weight:900; padding:8px 2px">Aún no hay registros.</div>`;
      return;
    }

    ops.slice().reverse().forEach(op=>{
      const dirTxt = op.direccion==="PE_RU" ? "PE → RU" : "RU → PE";
      const title = `${op.fecha} — ${dirTxt} — ${op.monedaEntrega} ${op.entrega}`;
      const sub = `Imp USD: ${op.importeUSD} | Com: ${op.comisionUSD} | Enviar: ${op.montoEnviarUSD}`;

      const row = document.createElement("div");
      row.className="item";
      row.innerHTML = `
        <div class="meta">
          <div class="t">${title}</div>
          <div class="s">${sub}${op.cliente ? " | " + op.cliente : ""}</div>
        </div>
        <div class="actions">
          <button class="mini" data-act="open">Abrir</button>
          <button class="mini" data-act="copy">Copiar</button>
          <button class="mini" data-act="del">Eliminar</button>
        </div>
      `;

      row.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          const act = b.getAttribute("data-act");
          if(act==="open") openReceiptModal(op);
          if(act==="copy"){
            navigator.clipboard.writeText(buildReceiptText(op));
            alert("✅ Texto copiado");
          }
          if(act==="del"){
            const all = loadOps();
            saveOps(all.filter(x=>x.id !== op.id));
            renderHistory();
          }
        });
      });

      box.appendChild(row);
    });
  }

  let currentOp = null;
  let currentDataUrl = null;

  function openReceiptModal(op){
    currentOp = op;
    $("pillDir").textContent = "✅ " + (op.direccion==="PE_RU" ? "Transferencia Perú → Rusia" : "Transferencia Rusia → Perú");
    $("txtRecibo").textContent = buildReceiptText(op);

    currentDataUrl = drawReceiptToCanvas(op);
    $("imgRecibo").src = currentDataUrl;

    const namePart = op.cliente ? `_${op.cliente.replaceAll(" ","_")}` : "";
    $("smallNote").textContent = `Archivo sugerido: ridmanpay_${op.fecha}_${op.direccion}_${op.monedaEntrega}_${op.entrega}${namePart}.png`;

    $("modalBack").style.display="flex";
  }

  function closeModal(){
    $("modalBack").style.display="none";
    currentOp = null;
    currentDataUrl = null;
  }

  function exportCSV(){
    const ops = loadOps();
    if(!ops.length){
      alert("No hay registros para exportar.");
      return;
    }
    const headers = [
      "fecha","direccion","monedaEntrega","entrega","tasaPeru","tasaRusia",
      "importeUSD","comisionUSD","montoEnviarUSD","recibeText","cliente","obs"
    ];
    const rows = [headers.join(",")];
    for(const o of ops){
      const line = headers.map(h=>{
        const v = (o[h] ?? "");
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      }).join(",");
      rows.push(line);
    }
    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ridmanpay_${todayISO()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  $("modoComision").addEventListener("change", ()=>{
    $("wrapComisionManual").style.display = ($("modoComision").value === "MANUAL") ? "block" : "none";
  });

  $("btnPreview").addEventListener("click", ()=>{
    openReceiptModal(computeOperationFromInputs());
  });

  $("btnGuardarAbrir").addEventListener("click", ()=>{
    const op = computeOperationFromInputs();
    const ops = loadOps();
    ops.push(op);
    saveOps(ops);
    renderHistory();
    openReceiptModal(op);
  });

  $("btnCopiarTexto").addEventListener("click", ()=>{
    navigator.clipboard.writeText(buildReceiptText(computeOperationFromInputs()));
    alert("✅ Texto copiado");
  });

  $("btnCsv").addEventListener("click", exportCSV);

  $("btnNuevo").addEventListener("click", ()=>{
    $("direccion").value="PE_RU";
    $("monedaEntrega").value="PEN";
    $("entrega").value="";
    $("tasaPeru").value="";
    $("tasaRusia").value="";
    $("cliente").value="";
    $("obs").value="";
    $("modoComision").value="AUTO";
    $("wrapComisionManual").style.display="none";
    $("comisionManual").value="";
    window.scrollTo({top:0, behavior:"smooth"});
  });

  $("btnBorrarTodo").addEventListener("click", ()=>{
    if(confirm("¿Borrar todos los registros?")){
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    }
  });

  $("btnClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{
    if(e.target === $("modalBack")) closeModal();
  });

  $("btnCopiarModal").addEventListener("click", ()=>{
    if(!currentOp) return;
    navigator.clipboard.writeText(buildReceiptText(currentOp));
    alert("✅ Texto copiado");
  });

  $("btnDescargarImg").addEventListener("click", ()=>{
    if(!currentOp || !currentDataUrl) return;
    const a = document.createElement("a");
    const namePart = currentOp.cliente ? `_${currentOp.cliente.replaceAll(" ","_")}` : "";
    a.download = `ridmanpay_${currentOp.fecha}_${currentOp.direccion}_${currentOp.monedaEntrega}_${currentOp.entrega}${namePart}.png`;
    a.href = currentDataUrl;
    a.click();
  });

  $("btnShareImg").addEventListener("click", async ()=>{
    if(!currentOp || !currentDataUrl) return;

    try{
      const res = await fetch(currentDataUrl);
      const blob = await res.blob();
      const fileName = `ridmanpay_${currentOp.fecha}_${currentOp.direccion}.png`;
      const file = new File([blob], fileName, {type:"image/png"});

      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({
          title: "Ridman Pay",
          text: "Recibo (imagen)",
          files: [file]
        });
      } else if(navigator.share){
        await navigator.share({
          title: "Ridman Pay",
          text: buildReceiptText(currentOp)
        });
        alert("Tu dispositivo no permite compartir imagen directo. Usa 'Descargar imagen'.");
      } else {
        alert("Tu navegador no permite compartir. Usa 'Descargar imagen'.");
      }
    }catch(err){
      console.log(err);
      alert("No se pudo compartir. Usa 'Descargar imagen'.");
    }
  });

  (function init(){
    $("fecha").value = todayISO();
    renderHistory();
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }
  })();

  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r,y);
      this.arcTo(x+w,y, x+w, y+h, r);
      this.arcTo(x+w,y+h, x, y+h, r);
      this.arcTo(x,y+h, x, y, r);
      this.arcTo(x,y, x+w, y, r);
      this.closePath();
      return this;
    }
  }
</script>

</body>
</html>
